# portfolio_company_analysis.py
"""
Geli≈ümi≈ü Portf√∂y ≈ûirketi Analiz Sistemi - Risk Assessment Entegre Edilmi≈ü
Portf√∂y y√∂netim ≈üirketlerinin kapsamlƒ± analizi ve risk deƒüerlendirmesi
"""
import time
import numpy as np
import pandas as pd
from risk_assessment import RiskAssessment

class EnhancedPortfolioCompanyAnalyzer:
    """Geli≈ümi≈ü Portf√∂y ≈ûirketi Analiz Sistemi - Risk Kontrol√º ƒ∞le"""
    
    def __init__(self, coordinator):
        self.coordinator = coordinator
        
        # üéØ GELƒ∞≈ûTƒ∞Rƒ∞LMƒ∞≈û ≈ûirket keyword mapping
        self.company_keywords = {
            'ƒ∞≈ü Portf√∂y': ['ƒ∞≈û PORTF√ñY', 'IS PORTFOY', 'ISBANK PORTFOY'],
            'Ak Portf√∂y': ['AK PORTF√ñY', 'AKBANK PORTF√ñY', 'AKPORTFOY'],
            'Garanti Portf√∂y': ['GARANTƒ∞ PORTF√ñY', 'GARANTI PORTFOY', 'GARANTIBANK'],
            'Ata Portf√∂y': ['ATA PORTF√ñY', 'ATA PORTFOY'],
            'QNB Portf√∂y': ['QNB PORTF√ñY', 'QNB PORTFOY', 'FINANSBANK'],
            'Fiba Portf√∂y': ['Fƒ∞BA PORTF√ñY', 'FIBA PORTFOY', 'FIBABANK'],
            'Yapƒ± Kredi Portf√∂y': ['YAPI KREDƒ∞ PORTF√ñY', 'YKB PORTF√ñY', 'YAPIKREDI'],
            'TEB Portf√∂y': ['TEB PORTF√ñY', 'TEB PORTFOY'],
            'Deniz Portf√∂y': ['DENƒ∞Z PORTF√ñY', 'DENIZ PORTFOY', 'DENIZBANK'],
            'Ziraat Portf√∂y': ['Zƒ∞RAAT PORTF√ñY', 'ZIRAAT PORTFOY', 'ZIRAATBANK'],
            'Halk Portf√∂y': ['HALK PORTF√ñY', 'HALK PORTFOY', 'HALKBANK'],
            'ƒ∞stanbul Portf√∂y': ['ƒ∞STANBUL PORTF√ñY', 'ISTANBUL PORTFOY'],
            'Vakƒ±f Portf√∂y': ['VAKIF PORTF√ñY', 'VAKIFBANK PORTF√ñY'],
            'ICBC Turkey Portf√∂y': ['ICBC', 'INDUSTRIAL'],
            'Bizim Portf√∂y': ['Bƒ∞Zƒ∞M PORTF√ñY', 'BIZIM PORTFOY'],
            'Tacirler Portf√∂y': ['TACƒ∞RLER PORTF√ñY', 'TACIRLER'],
            'Gedik Portf√∂y': ['GEDƒ∞K PORTF√ñY', 'GEDIK'],
            'Info Portf√∂y': ['INFO PORTF√ñY', 'INFORMATICS'],
            'Marmara Portf√∂y': ['MARMARA PORTF√ñY', 'MARMARA'],
            'Kare Portf√∂y': ['KARE PORTF√ñY', 'KARE'],
            'Strateji Portf√∂y': ['STRATEJƒ∞ PORTF√ñY', 'STRATEJI'],
            'Global Portf√∂y': ['GLOBAL PORTF√ñY', 'GLOBAL MD'],
            'Azimut Portf√∂y': ['AZƒ∞MUT PORTF√ñY', 'AZIMUT'],
            'ING Portf√∂y': ['ING PORTF√ñY', 'ING BANK']
        }
    
    def get_all_company_funds_unlimited(self, company_name):
        """≈ûirketin T√úM fonlarƒ±nƒ± bul - Lƒ∞Mƒ∞TSƒ∞Z"""
        print(f"üîç {company_name} - T√úM fonlarƒ± aranƒ±yor (limitsiz)...")
        
        try:
            company_funds = []
            keywords = self.company_keywords.get(company_name, [])
            
            if not keywords:
                print(f"   ‚ö†Ô∏è {company_name} i√ßin keyword bulunamadƒ±")
                return []
            
            for keyword in keywords:
                try:
                    # üöÄ Lƒ∞Mƒ∞TSƒ∞Z SORGU - T√ºm fonlarƒ± bul
                    query = f"""
                        SELECT 
                            fcode,
                            fund_name,
                            fcapacity,
                            investorcount,
                            current_price
                        FROM mv_portfolio_company_summary
                        WHERE company_name = %s
                        ORDER BY fcapacity DESC NULLS LAST
"""
                    
                    result = self.coordinator.db.execute_query(query)
                    
                    for _, row in result.iterrows():
                        fund_info = {
                            'fcode': row['fcode'],
                            'fund_name': row['fund_name'],
                            'capacity': float(row['fcapacity']) if pd.notna(row['fcapacity']) else 0,
                            'investors': int(row['investorcount']) if pd.notna(row['investorcount']) else 0,
                            'current_price': float(row['price']) if pd.notna(row['price']) else 0
                        }
                        
                        # Duplicate kontrol√º
                        if not any(f['fcode'] == fund_info['fcode'] for f in company_funds):
                            company_funds.append(fund_info)
                            
                except Exception as e:
                    print(f"   ‚ö†Ô∏è Keyword '{keyword}' sorgu hatasƒ±: {e}")
                    continue
            
            print(f"   ‚úÖ {len(company_funds)} FON BULUNDU")
            return company_funds
            
        except Exception as e:
            print(f"   ‚ùå Genel hata: {e}")
            return []

    def calculate_comprehensive_performance(self, fund_code, days=252):
        """MV kullanarak hƒ±zlƒ± performans hesaplama"""
        try:
            # √ñnce MV'den hazƒ±r metrikleri al
            query = """
            SELECT * FROM mv_fund_performance_metrics
            WHERE fcode = :fcode
            """
            result = self.coordinator.db.execute_query(query, {'fcode': fund_code})            
            if not result.empty:
                row = result.iloc[0]
                
                # Sortino ratio i√ßin yakla≈üƒ±k hesaplama
                sortino_ratio = row['sharpe_ratio'] * 1.2  # Yakla≈üƒ±k deƒüer
                
                # Max drawdown i√ßin yakla≈üƒ±k hesaplama
                if row['calmar_ratio'] > 0 and row['annual_return'] > 0:
                    max_drawdown = abs(row['annual_return'] / row['calmar_ratio'])
                else:
                    max_drawdown = row['annual_volatility'] * 2  # Yakla≈üƒ±k
                
                return {
                    'total_return': (row['annual_return'] / 252 * min(days, row['data_points'])) * 100,
                    'annual_return': row['annual_return'] * 100,
                    'volatility': row['annual_volatility'] * 100,
                    'sharpe_ratio': row['sharpe_ratio'],
                    'sortino_ratio': sortino_ratio,
                    'calmar_ratio': row['calmar_ratio'],
                    'win_rate': row['win_rate'] * 100,
                    'max_drawdown': max_drawdown,
                    'data_points': row['data_points'],
                    'current_price': row['current_price']
                }
        except Exception as e:
            print(f"MV sorgu hatasƒ±: {e}, fallback kullanƒ±lƒ±yor")
        
        # Orijinal hesaplama (MV yoksa veya hata varsa)
        try:
            # Veri √ßekimi
            data = self.coordinator.db.get_fund_price_history(fund_code, days)
            
            if len(data) < 10:
                return None
            
            prices = data.set_index('pdate')['price'].sort_index()
            returns = prices.pct_change().dropna()
            
            # ƒ∞lk ve son fiyat kontrol√º
            first_price = prices.iloc[0]
            last_price = prices.iloc[-1]
            
            if first_price <= 0 or last_price <= 0 or pd.isna(first_price) or pd.isna(last_price):
                print(f"   ‚ö†Ô∏è {fund_code} ge√ßersiz fiyat verisi: ba≈ülangƒ±√ß={first_price}, son={last_price}")
                return None
            
            # Temel metrikler
            total_return = (last_price / first_price - 1) * 100
            
            returns_std = returns.std()
            if pd.isna(returns_std) or returns_std == 0:
                print(f"   ‚ö†Ô∏è {fund_code} volatilite hesaplanamadƒ±")
                return None
            
            annual_return = total_return * (252 / len(prices))
            volatility = returns_std * np.sqrt(252) * 100
            
            # Sharpe ratio
            if volatility > 0 and not pd.isna(volatility):
                sharpe = (annual_return - 15) / volatility
            else:
                sharpe = 0
            
            win_rate = (returns > 0).sum() / len(returns) * 100
            
            # Max drawdown
            try:
                cumulative = (1 + returns).cumprod()
                running_max = cumulative.expanding().max()
                drawdown = (cumulative - running_max) / running_max
                max_drawdown = abs(drawdown.min()) * 100
                
                if pd.isna(max_drawdown):
                    max_drawdown = 0
            except Exception:
                max_drawdown = 0
            
            # Calmar ratio
            if max_drawdown > 0 and not pd.isna(max_drawdown):
                calmar = abs(annual_return / max_drawdown)
            else:
                calmar = 0
            
            # Sortino ratio
            negative_returns = returns[returns < 0]
            if len(negative_returns) > 0:
                downside_std = negative_returns.std()
                if not pd.isna(downside_std) and downside_std > 0:
                    downside_deviation = downside_std * np.sqrt(252) * 100
                    sortino = (annual_return - 15) / downside_deviation
                else:
                    sortino = 0
            else:
                sortino = sharpe * 1.5  # Yakla≈üƒ±k deƒüer
            
            result = {
                'total_return': total_return,
                'annual_return': annual_return,
                'volatility': volatility,
                'sharpe_ratio': sharpe,
                'sortino_ratio': sortino,
                'calmar_ratio': calmar,
                'win_rate': win_rate,
                'max_drawdown': max_drawdown,
                'data_points': len(prices),
                'current_price': last_price
            }
            
            # Infinity ve NaN temizleme
            for key, value in result.items():
                if pd.isna(value) or np.isinf(value):
                    print(f"   ‚ö†Ô∏è {fund_code} {key} deƒüeri ge√ßersiz: {value}")
                    if key in ['sharpe_ratio', 'sortino_ratio', 'calmar_ratio']:
                        result[key] = 0
                    elif key in ['volatility', 'max_drawdown']:
                        result[key] = 0
                    else:
                        result[key] = 0
            
            return result
            
        except Exception as e:
            print(f"   ‚ùå {fund_code} performans hatasƒ±: {e}")
            return None

    def analyze_company_comprehensive(self, company_name, analysis_days=252):
        """≈ûirket kapsamlƒ± analizi - T√úM FONLARLA + Rƒ∞SK DEƒûERLENDƒ∞RME"""
        print(f"\nüè¢ {company_name.upper()} - KAPSAMLI ANALƒ∞Z BA≈ûLATIYOR (Rƒ∞SK KONTROL√ú ƒ∞LE)...")
        print("="*70)
        
        start_time = time.time()
        
        # 1. T√úM FONLARI BUL
        company_funds = self.get_all_company_funds_unlimited(company_name)
        
        if not company_funds:
            return f"‚ùå {company_name} fonlarƒ± bulunamadƒ±."
        
        print(f"üìä BULUNAN FONLAR: {len(company_funds)}")
        print(f"üìÖ ANALƒ∞Z PERƒ∞YODU: {analysis_days} g√ºn")
        print(f"üõ°Ô∏è Rƒ∞SK DEƒûERLENDƒ∞RMESƒ∞: Aktif")
        
        # 2. HER FON ƒ∞√áƒ∞N DETAYLI PERFORMANS ANALƒ∞Zƒ∞ + Rƒ∞SK KONTROL√ú
        print(f"\nüîç PERFORMANS + Rƒ∞SK ANALƒ∞Zƒ∞ BA≈ûLATIYOR...")
        
        performance_results = []
        high_risk_funds = []
        blocked_extreme_funds = []
        successful_analysis = 0
        
        for i, fund_info in enumerate(company_funds, 1):
            fcode = fund_info['fcode']
            print(f"   [{i}/{len(company_funds)}] {fcode}...", end='')
            
            # 1. Performans hesaplama
            perf = self.calculate_comprehensive_performance(fcode, analysis_days)
            
            if perf:
                # 2. Risk deƒüerlendirmesi - MV'den risk verileri √ßek
                risk_data = self._get_fund_risk_data(fcode)
                
                if risk_data:
                    risk_assessment = RiskAssessment.assess_fund_risk(risk_data)
                    
                    fund_result = {
                        'fcode': fcode,
                        'fund_name': fund_info['fund_name'],
                        'capacity': fund_info['capacity'],
                        'investors': fund_info['investors'],
                        'risk_level': risk_assessment['risk_level'],
                        'risk_factors': risk_assessment['risk_factors'],
                        'risk_score': risk_assessment['risk_score'],
                        **perf  # Performans metriklerini ekle
                    }
                    
                    # Risk seviyesine g√∂re kategorize et
                    if risk_assessment['risk_level'] == 'EXTREME':
                        blocked_extreme_funds.append(fund_result)
                        print(f" üî¥ EXTREME Rƒ∞SK - ENGELLENDƒ∞")
                    elif risk_assessment['risk_level'] in ['HIGH']:
                        high_risk_funds.append(fund_result)
                        performance_results.append(fund_result)
                        print(f" üü† Y√úKSEK Rƒ∞SK ({perf['annual_return']:+.1f}%)")
                    else:
                        performance_results.append(fund_result)
                        print(f" ‚úÖ {risk_assessment['risk_level']} ({perf['annual_return']:+.1f}%)")
                    
                    successful_analysis += 1
                else:
                    # Risk verisi yoksa sadece performans kaydet
                    fund_result = {
                        'fcode': fcode,
                        'fund_name': fund_info['fund_name'],
                        'capacity': fund_info['capacity'],
                        'investors': fund_info['investors'],
                        'risk_level': 'UNKNOWN',
                        'risk_factors': [],
                        'risk_score': 0,
                        **perf
                    }
                    performance_results.append(fund_result)
                    successful_analysis += 1
                    print(f" ‚ö™ Rƒ∞SK Bƒ∞Lƒ∞NMƒ∞YOR ({perf['annual_return']:+.1f}%)")
            else:
                print(f" ‚ùå")
        
        elapsed = time.time() - start_time
        print(f"\n‚è±Ô∏è ANALƒ∞Z TAMAMLANDI: {elapsed:.1f} saniye")
        print(f"‚úÖ BA≈ûARILI: {successful_analysis}/{len(company_funds)} fon")
        print(f"üõ°Ô∏è G√úVENLƒ∞/ORTA: {len(performance_results) - len(high_risk_funds)} fon")
        print(f"üü† Y√úKSEK Rƒ∞SK: {len(high_risk_funds)} fon")
        print(f"üî¥ EXTREME (ENGELLENEN): {len(blocked_extreme_funds)} fon")
        
        if not performance_results:
            return f"‚ùå {company_name} i√ßin performans verisi hesaplanamadƒ±."
        
        # 3. SONU√áLARI FORMATLA - Rƒ∞SK Bƒ∞LGƒ∞LERƒ∞ ƒ∞LE
        return self.format_company_analysis_results_with_risk(
            company_name, 
            performance_results, 
            high_risk_funds,
            blocked_extreme_funds, 
            elapsed
        )

    def _get_fund_risk_data(self, fcode):
        """Fonun risk verilerini MV'den √ßek"""
        try:
            query = """
            SELECT 
                price_vs_sma20,
                rsi_14,
                stochastic_14,
                days_since_last_trade,
                investorcount
            FROM mv_fund_technical_indicators
            WHERE fcode = %s
            """
            
            result = self.coordinator.db.execute_query(query, [fcode])
            
            if not result.empty:
                row = result.iloc[0]
                
                return {
                    'fcode': fcode,
                    'price_vs_sma20': float(row.get('price_vs_sma20', 0)),
                    'rsi_14': float(row.get('rsi_14', 50)),
                    'stochastic_14': float(row.get('stochastic_14', 50)),
                    'days_since_last_trade': int(row.get('days_since_last_trade', 0)),
                    'investorcount': int(row.get('investorcount', 0))
                }
            else:
                return None
                
        except Exception as e:
            print(f"Risk veri hatasƒ± ({fcode}): {e}")
            return None

    def format_company_analysis_results_with_risk(self, company_name, results, high_risk_funds, blocked_funds, analysis_time):
        """Analiz sonu√ßlarƒ±nƒ± formatla - Rƒ∞SK Bƒ∞LGƒ∞LERƒ∞ ƒ∞LE"""
        
        # Sonu√ßlarƒ± Sharpe ratio'ya g√∂re sƒ±rala
        results.sort(key=lambda x: x['sharpe_ratio'], reverse=True)
        
        response = f"\nüè¢ {company_name.upper()} - KAPSAMLI ANALƒ∞Z RAPORU (Rƒ∞SK KONTROL√ú ƒ∞LE)\n"
        response += f"{'='*70}\n\n"
        
        # √ñZET ƒ∞STATƒ∞STƒ∞KLER - g√ºvenli hesaplama
        total_funds = len(results) + len(blocked_funds)
        safe_funds = len(results) - len(high_risk_funds)
        total_capacity = sum(r['capacity'] for r in results)
        total_investors = sum(r['investors'] for r in results)
        
        # üîß D√úZELTƒ∞LMƒ∞≈û: INF ve NaN deƒüerleri filtrele
        valid_returns = [r['annual_return'] for r in results if not (pd.isna(r['annual_return']) or np.isinf(r['annual_return']))]
        valid_sharpes = [r['sharpe_ratio'] for r in results if not (pd.isna(r['sharpe_ratio']) or np.isinf(r['sharpe_ratio']))]
        valid_volatilities = [r['volatility'] for r in results if not (pd.isna(r['volatility']) or np.isinf(r['volatility']))]
        
        avg_return = sum(valid_returns) / len(valid_returns) if valid_returns else 0
        avg_sharpe = sum(valid_sharpes) / len(valid_sharpes) if valid_sharpes else 0
        avg_volatility = sum(valid_volatilities) / len(valid_volatilities) if valid_volatilities else 0
        
        response += f"üìä ≈ûƒ∞RKET GENEL ƒ∞STATƒ∞STƒ∞KLERƒ∞:\n"
        response += f"   üî¢ Toplam Fon Sayƒ±sƒ±: {total_funds}\n"
        response += f"   üõ°Ô∏è G√ºvenli/Orta Risk: {safe_funds} fon (%{safe_funds/total_funds*100:.1f})\n"
        response += f"   üü† Y√ºksek Risk: {len(high_risk_funds)} fon (%{len(high_risk_funds)/total_funds*100:.1f})\n"
        response += f"   üî¥ Extreme (Engellenen): {len(blocked_funds)} fon (%{len(blocked_funds)/total_funds*100:.1f})\n"
        response += f"   üí∞ Toplam Varlƒ±k: {total_capacity:,.0f} TL ({total_capacity/1000000000:.1f} milyar)\n"
        response += f"   üë• Toplam Yatƒ±rƒ±mcƒ±: {total_investors:,} ki≈üi\n"
        response += f"   üìà Ortalama Yƒ±llƒ±k Getiri: %{avg_return:+.2f}\n"
        response += f"   ‚ö° Ortalama Sharpe Oranƒ±: {avg_sharpe:.3f}\n"
        response += f"   üìä Ortalama Volatilite: %{avg_volatility:.2f}\n"
        response += f"   ‚è±Ô∏è Analiz S√ºresi: {analysis_time:.1f} saniye\n\n"
        
        # EN ƒ∞Yƒ∞ PERFORMANS FONLARI (G√ú√áEK REHBERLƒ∞K ƒ∞LE)
        valid_results = [r for r in results if not (pd.isna(r['sharpe_ratio']) or np.isinf(r['sharpe_ratio']))]
        
        response += f"üèÜ EN ƒ∞Yƒ∞ PERFORMANS FONLARI (Risk-Ayarlƒ±):\n\n"
        
        for i, fund in enumerate(valid_results[:10], 1):
            # Performance tier belirleme
            if fund['sharpe_ratio'] > 1.0:
                tier = "üåü M√úKEMMEL"
            elif fund['sharpe_ratio'] > 0.5:
                tier = "‚≠ê √áOK ƒ∞Yƒ∞"
            elif fund['sharpe_ratio'] > 0:
                tier = "üî∂ ƒ∞Yƒ∞"
            elif fund['sharpe_ratio'] > -0.5:
                tier = "üî∏ ORTA"
            else:
                tier = "üîª ZAYIF"
            
            # Risk g√∂stergesi
            risk_indicator = self._get_risk_indicator(fund['risk_level'])
            
            response += f"{i:2d}. {fund['fcode']} - {tier} {risk_indicator}\n"
            response += f"    üìà Yƒ±llƒ±k Getiri: %{fund['annual_return']:+.2f}\n"
            response += f"    ‚ö° Sharpe Oranƒ±: {fund['sharpe_ratio']:.3f}\n"
            response += f"    üìä Volatilite: %{fund['volatility']:.2f}\n"
            response += f"    üéØ Kazanma Oranƒ±: %{fund['win_rate']:.1f}\n"
            response += f"    üìâ Max D√º≈ü√º≈ü: %{fund['max_drawdown']:.2f}\n"
            response += f"    üõ°Ô∏è Risk Seviyesi: {fund['risk_level']}\n"
            response += f"    üí∞ Kapasite: {fund['capacity']:,.0f} TL\n"
            response += f"    üë• Yatƒ±rƒ±mcƒ±: {fund['investors']:,} ki≈üi\n"
            
            # Risk fakt√∂rleri varsa g√∂ster
            if fund['risk_factors'] and fund['risk_level'] in ['HIGH', 'EXTREME']:
                top_risks = [f['factor'] for f in fund['risk_factors'][:2]]
                response += f"    ‚ö†Ô∏è Risk Fakt√∂rleri: {', '.join(top_risks)}\n"
            
            response += f"    üìù Adƒ±: {fund['fund_name'][:45]}...\n"
            response += f"\n"
        
        # Y√úKSEK Rƒ∞SKLƒ∞ FONLAR UYARISI
        if high_risk_funds:
            response += f"üü† Y√úKSEK Rƒ∞SKLƒ∞ FONLAR ({len(high_risk_funds)} adet):\n"
            response += f"   ‚ö†Ô∏è Bu fonlar y√ºksek risk ta≈üƒ±maktadƒ±r, dikkatli olun!\n\n"
            
            for i, fund in enumerate(high_risk_funds[:5], 1):
                risk_factors = [f['factor'] for f in fund['risk_factors'][:2]]
                response += f"   {i}. {fund['fcode']} - %{fund['annual_return']:+.1f} getiri\n"
                response += f"      ‚ö†Ô∏è Risk: {', '.join(risk_factors)}\n"
            
            if len(high_risk_funds) > 5:
                response += f"      ... ve {len(high_risk_funds) - 5} fon daha\n"
            response += f"\n"
        
        # EXTREME Rƒ∞SKLƒ∞ (ENGELLENEN) FONLAR
        if blocked_funds:
            response += f"üî¥ EXTREME Rƒ∞SKLƒ∞ FONLAR - √ñNERƒ∞LMƒ∞YOR ({len(blocked_funds)} adet):\n"
            response += f"   ‚ùå Bu fonlar extreme risk ta≈üƒ±dƒ±ƒüƒ± i√ßin portf√∂y √∂nerilerinde yer almaz!\n\n"
            
            for i, fund in enumerate(blocked_funds[:5], 1):
                top_risk_factors = [f['factor'] for f in fund['risk_factors'][:2]]
                response += f"   {i}. {fund['fcode']} - ENGELLENEN\n"
                response += f"      üö® Sebepler: {', '.join(top_risk_factors)}\n"
            
            if len(blocked_funds) > 5:
                response += f"      ... ve {len(blocked_funds) - 5} fon daha\n"
            response += f"\n"
        
        # KATEGORƒ∞ Lƒ∞DERLERƒ∞ - g√ºvenli
        if valid_results:
            # En y√ºksek getiri - INF olmayan
            best_return_fund = max(valid_results, key=lambda x: x['annual_return'] if not np.isinf(x['annual_return']) else -999)
            best_sharpe_fund = max(valid_results, key=lambda x: x['sharpe_ratio'])
            lowest_vol_fund = min(valid_results, key=lambda x: x['volatility'] if x['volatility'] > 0 else 999)
            safest_fund = min(valid_results, key=lambda x: 0 if x['risk_level'] == 'LOW' else 1 if x['risk_level'] == 'MEDIUM' else 2)
            
            response += f"üèÖ KATEGORƒ∞ Lƒ∞DERLERƒ∞:\n"
            response += f"   ü•á En Y√ºksek Getiri: {best_return_fund['fcode']} (%{best_return_fund['annual_return']:+.1f})\n"
            response += f"   üõ°Ô∏è En D√º≈ü√ºk Risk: {lowest_vol_fund['fcode']} (%{lowest_vol_fund['volatility']:.1f})\n"
            response += f"   ‚ö° En Y√ºksek Sharpe: {best_sharpe_fund['fcode']} ({best_sharpe_fund['sharpe_ratio']:.3f})\n"
            response += f"   üîí En G√ºvenli: {safest_fund['fcode']} ({safest_fund['risk_level']} risk)\n"
            response += f"   üí∞ En B√ºy√ºk Fon: {max(results, key=lambda x: x['capacity'])['fcode']} ({max(results, key=lambda x: x['capacity'])['capacity']/1000000:.0f}M TL)\n"
            response += f"   üë• En Pop√ºler: {max(results, key=lambda x: x['investors'])['fcode']} ({max(results, key=lambda x: x['investors'])['investors']:,} ki≈üi)\n"
        
        # Rƒ∞SK DAƒûILIMI ANALƒ∞Zƒ∞
        risk_distribution = {}
        for fund in results + blocked_funds:
            risk_level = fund['risk_level']
            risk_distribution[risk_level] = risk_distribution.get(risk_level, 0) + 1
        
        response += f"\nüõ°Ô∏è Rƒ∞SK SEVƒ∞YESƒ∞ DAƒûILIMI:\n"
        for risk_level in ['LOW', 'MEDIUM', 'HIGH', 'EXTREME', 'UNKNOWN']:
            count = risk_distribution.get(risk_level, 0)
            if count > 0:
                percentage = count / total_funds * 100
                indicator = self._get_risk_indicator(risk_level)
                response += f"   {indicator} {risk_level}: {count} fon (%{percentage:.1f})\n"
        
        # PERFORMANCE DAƒûILIMI - ge√ßerli verilerle
        if valid_results:
            excellent_funds = len([f for f in valid_results if f['sharpe_ratio'] > 1.0])
            good_funds = len([f for f in valid_results if 0.5 < f['sharpe_ratio'] <= 1.0])
            average_funds = len([f for f in valid_results if 0 < f['sharpe_ratio'] <= 0.5])
            poor_funds = len([f for f in valid_results if f['sharpe_ratio'] <= 0])
            
            response += f"\nüìä PERFORMANS DAƒûILIMI:\n"
            response += f"   üåü M√ºkemmel (Sharpe>1.0): {excellent_funds} fon (%{excellent_funds/len(valid_results)*100:.1f})\n"
            response += f"   ‚≠ê √áok ƒ∞yi (0.5-1.0): {good_funds} fon (%{good_funds/len(valid_results)*100:.1f})\n"
            response += f"   üî∂ ƒ∞yi (0-0.5): {average_funds} fon (%{average_funds/len(valid_results)*100:.1f})\n"
            response += f"   üîª Zayƒ±f (‚â§0): {poor_funds} fon (%{poor_funds/len(valid_results)*100:.1f})\n"
        
        # GENEL DEƒûERLENDƒ∞RME - Rƒ∞SK DAHƒ∞L
        if avg_sharpe > 0.5:
            overall_rating = "üåü M√úKEMMEL"
        elif avg_sharpe > 0.2:
            overall_rating = "‚≠ê √áOK ƒ∞Yƒ∞"
        elif avg_sharpe > 0:
            overall_rating = "üî∂ ƒ∞Yƒ∞"
        elif avg_sharpe > -0.2:
            overall_rating = "üî∏ ORTA"
        else:
            overall_rating = "üîª ZAYIF"
        
        # Risk fakt√∂r√º de deƒüerlendirmeye dahil et
        risk_penalty = 0
        if len(blocked_funds) > total_funds * 0.2:  # %20'den fazla extreme risk
            risk_penalty = 1
        elif len(high_risk_funds) > total_funds * 0.3:  # %30'dan fazla y√ºksek risk
            risk_penalty = 0.5
        
        response += f"\nüéØ GENEL DEƒûERLENDƒ∞RME: {overall_rating}"
        if risk_penalty > 0:
            response += f" ‚ö†Ô∏è (Risk cezasƒ±: -{risk_penalty:.1f})"
        response += f"\n"
        
        response += f"   Ortalama Sharpe {avg_sharpe:.3f} ile {company_name} "
        
        if avg_sharpe > 0.3 and risk_penalty < 0.5:
            response += "g√º√ßl√º ve g√ºvenli performans sergiliyor.\n"
        elif avg_sharpe > 0 and risk_penalty < 1:
            response += "makul performans g√∂steriyor ancak risk kontrol√º √∂nemli.\n"
        else:
            response += "performansƒ±nƒ± ve risk y√∂netimini iyile≈ütirmesi gerekiyor.\n"
        
        # YATIRIM TAVSƒ∞YELERƒ∞
        response += f"\nüí° YATIRIM TAVSƒ∞YELERƒ∞:\n"
        
        if safe_funds > total_funds * 0.7:
            response += f"   ‚úÖ {company_name} genel olarak g√ºvenli fonlar sunuyor\n"
        
        if len(high_risk_funds) > 0:
            response += f"   ‚ö†Ô∏è {len(high_risk_funds)} y√ºksek riskli fon var - dikkatli se√ßim yapƒ±n\n"
        
        if len(blocked_funds) > 0:
            response += f"   üö® {len(blocked_funds)} extreme riskli fon var - bunlardan ka√ßƒ±nƒ±n\n"
        
        if valid_results:
            best_fund = valid_results[0]
            response += f"   üéØ En g√ºvenli se√ßim: {best_fund['fcode']} ({best_fund['risk_level']} risk)\n"
        
        response += f"   üîç Yatƒ±rƒ±m √∂ncesi mutlaka risk seviyelerini kontrol edin\n"
        
        return response

    def _get_risk_indicator(self, risk_level):
        """Risk seviyesi g√∂stergesi"""
        indicators = {
            'LOW': 'üü¢',
            'MEDIUM': 'üü°',
            'HIGH': 'üü†',
            'EXTREME': 'üî¥',
            'UNKNOWN': '‚ö™'
        }
        return indicators.get(risk_level, '‚ö™')

    def compare_companies_unlimited(self, company1, company2, analysis_days=252):
        """ƒ∞ki ≈üirketi kapsamlƒ± kar≈üƒ±la≈ütƒ±r - Lƒ∞Mƒ∞TSƒ∞Z + Rƒ∞SK KONTROL√ú"""
        print(f"\n‚öñÔ∏è {company1} vs {company2} - KAPSAMLI KAR≈ûILA≈ûTIRMA (Rƒ∞SK KONTROL√ú ƒ∞LE)")
        print("="*75)
        
        # Her iki ≈üirket i√ßin analiz
        results1 = self.analyze_company_detailed_data_with_risk(company1, analysis_days)
        results2 = self.analyze_company_detailed_data_with_risk(company2, analysis_days)
        
        if not results1['success'] or not results2['success']:
            return f"‚ùå Kar≈üƒ±la≈ütƒ±rma i√ßin yeterli veri yok."
        
        response = f"\n‚öñÔ∏è {company1.upper()} vs {company2.upper()} - DETAYLI KAR≈ûILA≈ûTIRMA (Rƒ∞SK DAHƒ∞L)\n"
        response += f"{'='*75}\n\n"
        
        # GENEL ƒ∞STATƒ∞STƒ∞KLER KAR≈ûILA≈ûTIRMASI
        metrics = [
            ('Fon Sayƒ±sƒ±', 'total_funds', 'adet', 'higher'),
            ('G√ºvenli Fon %', 'safe_fund_ratio', '%', 'higher'),
            ('Toplam Varlƒ±k', 'total_capacity', 'milyar TL', 'higher'), 
            ('Ortalama Getiri', 'avg_return', '%', 'higher'),
            ('Ortalama Sharpe', 'avg_sharpe', '', 'higher'),
            ('Ortalama Risk', 'avg_volatility', '%', 'lower'),
            ('Risk Skoru', 'risk_score', '/10', 'higher')
        ]
        
        response += f"üìä GENEL KAR≈ûILA≈ûTIRMA (Rƒ∞SK DAHƒ∞L):\n\n"
        response += f"{'Metrik':<15} | {company1:<15} | {company2:<15} | Kazanan\n"
        response += f"{'-'*15}|{'-'*16}|{'-'*16}|{'-'*15}\n"
        
        score1 = 0
        score2 = 0
        
        for metric_name, key, unit, better in metrics:
            val1 = results1['stats'][key]
            val2 = results2['stats'][key]
            
            # Deƒüer formatlama
            if 'milyar' in unit:
                val1_display = f"{val1/1000000000:.1f}"
                val2_display = f"{val2/1000000000:.1f}"
            elif '%' in unit and key == 'safe_fund_ratio':
                val1_display = f"{val1:.1f}"
                val2_display = f"{val2:.1f}"
            elif '%' in unit:
                val1_display = f"{val1:+.1f}"
                val2_display = f"{val2:+.1f}"
            elif '/10' in unit:
                val1_display = f"{val1:.1f}"
                val2_display = f"{val2:.1f}"
            else:
                val1_display = f"{val1:.2f}"
                val2_display = f"{val2:.2f}"
            
            # Kazanan belirleme
            if better == 'higher':
                winner = company1 if val1 > val2 else company2
                if val1 > val2:
                    score1 += 1
                else:
                    score2 += 1
            else:  # lower is better (risk)
                winner = company1 if val1 < val2 else company2
                if val1 < val2:
                    score1 += 1
                else:
                    score2 += 1
            
            response += f"{metric_name:<15} | {val1_display:<15} | {val2_display:<15} | üèÜ {winner}\n"
        
        # GENEL SKOR
        response += f"\nüèÜ GENEL SKOR: {company1} {score1}-{score2} {company2}\n"
        
        if score1 > score2:
            overall_winner = company1
            response += f"ü•á KAZANAN: {company1}\n"
        elif score2 > score1:
            overall_winner = company2
            response += f"ü•á KAZANAN: {company2}\n"
        else:
            response += f"ü§ù BERABERE\n"
        
        # Rƒ∞SK KAR≈ûILA≈ûTIRMASI
        response += f"\nüõ°Ô∏è Rƒ∞SK ANALƒ∞Zƒ∞ KAR≈ûILA≈ûTIRMASI:\n\n"
        
        response += f"üè¢ {company1.upper()}:\n"
        response += f"   üü¢ D√º≈ü√ºk Risk: {results1['risk_stats']['low_risk']} fon\n"
        response += f"   üü° Orta Risk: {results1['risk_stats']['medium_risk']} fon\n"
        response += f"   üü† Y√ºksek Risk: {results1['risk_stats']['high_risk']} fon\n"
        response += f"   üî¥ Extreme Risk: {results1['risk_stats']['extreme_risk']} fon\n"
        
        response += f"\nüè¢ {company2.upper()}:\n"
        response += f"   üü¢ D√º≈ü√ºk Risk: {results2['risk_stats']['low_risk']} fon\n"
        response += f"   üü° Orta Risk: {results2['risk_stats']['medium_risk']} fon\n"
        response += f"   üü† Y√ºksek Risk: {results2['risk_stats']['high_risk']} fon\n"
        response += f"   üî¥ Extreme Risk: {results2['risk_stats']['extreme_risk']} fon\n"
        
        # EN ƒ∞Yƒ∞ FONLAR KAR≈ûILA≈ûTIRMASI
        response += f"\nüåü EN ƒ∞Yƒ∞ FONLAR KAR≈ûILA≈ûTIRMASI (Risk-Ayarlƒ±):\n\n"
        
        response += f"üè¢ {company1.upper()} EN ƒ∞Yƒ∞LERƒ∞:\n"
        for i, fund in enumerate(results1['top_funds'][:3], 1):
            risk_indicator = self._get_risk_indicator(fund['risk_level'])
            response += f"   {i}. {fund['fcode']}: Sharpe {fund['sharpe_ratio']:.3f}, Getiri %{fund['annual_return']:+.1f} {risk_indicator}\n"
        
        response += f"\nüè¢ {company2.upper()} EN ƒ∞Yƒ∞LERƒ∞:\n"
        for i, fund in enumerate(results2['top_funds'][:3], 1):
            risk_indicator = self._get_risk_indicator(fund['risk_level'])
            response += f"   {i}. {fund['fcode']}: Sharpe {fund['sharpe_ratio']:.3f}, Getiri %{fund['annual_return']:+.1f} {risk_indicator}\n"
        
        # G√ú√áL√ú/ZAYIF Y√ñNLER - Rƒ∞SK DAHƒ∞L
        response += f"\nüí™ G√ú√áL√ú Y√ñNLER:\n"
        response += f"üè¢ {company1}:\n"
        if results1['stats']['avg_sharpe'] > results2['stats']['avg_sharpe']:
            response += f"   ‚úÖ Daha iyi risk-ayarlƒ± getiri\n"
        if results1['stats']['safe_fund_ratio'] > results2['stats']['safe_fund_ratio']:
            response += f"   ‚úÖ Daha g√ºvenli fon portf√∂y√º\n"
        if results1['stats']['total_capacity'] > results2['stats']['total_capacity']:
            response += f"   ‚úÖ Daha b√ºy√ºk varlƒ±k y√∂netimi\n"
        if results1['risk_stats']['extreme_risk'] < results2['risk_stats']['extreme_risk']:
            response += f"   ‚úÖ Daha az extreme riskli fon\n"
        
        response += f"\nüè¢ {company2}:\n"
        if results2['stats']['avg_sharpe'] > results1['stats']['avg_sharpe']:
            response += f"   ‚úÖ Daha iyi risk-ayarlƒ± getiri\n"
        if results2['stats']['safe_fund_ratio'] > results1['stats']['safe_fund_ratio']:
            response += f"   ‚úÖ Daha g√ºvenli fon portf√∂y√º\n"
        if results2['stats']['total_capacity'] > results1['stats']['total_capacity']:
            response += f"   ‚úÖ Daha b√ºy√ºk varlƒ±k y√∂netimi\n"
        if results2['risk_stats']['extreme_risk'] < results1['risk_stats']['extreme_risk']:
            response += f"   ‚úÖ Daha az extreme riskli fon\n"
        
        # YATIRIM TAVSƒ∞YELERƒ∞
        response += f"\nüí° YATIRIM TAVSƒ∞YELERƒ∞:\n"
        
        safer_company = company1 if results1['stats']['safe_fund_ratio'] > results2['stats']['safe_fund_ratio'] else company2
        better_performance = company1 if results1['stats']['avg_sharpe'] > results2['stats']['avg_sharpe'] else company2
        
        response += f"   üõ°Ô∏è G√ºvenlik i√ßin: {safer_company}\n"
        response += f"   üìà Performans i√ßin: {better_performance}\n"
        response += f"   ‚ö†Ô∏è Her iki ≈üirkette de risk kontrol√º yapƒ±n\n"
        response += f"   üéØ Extreme riskli fonlardan ka√ßƒ±nƒ±n\n"
        
        return response

    def analyze_company_detailed_data_with_risk(self, company_name, analysis_days=252):
        """≈ûirket i√ßin detaylƒ± veri analizi (kar≈üƒ±la≈ütƒ±rma i√ßin) - Rƒ∞SK DAHƒ∞L"""
        try:
            company_funds = self.get_all_company_funds_unlimited(company_name)
            
            if not company_funds:
                return {'success': False}
            
            performance_results = []
            risk_stats = {'low_risk': 0, 'medium_risk': 0, 'high_risk': 0, 'extreme_risk': 0}
            
            for fund_info in company_funds:
                perf = self.calculate_comprehensive_performance(fund_info['fcode'], analysis_days)
                if perf:
                    # Risk deƒüerlendirmesi
                    risk_data = self._get_fund_risk_data(fund_info['fcode'])
                    
                    if risk_data:
                        risk_assessment = RiskAssessment.assess_fund_risk(risk_data)
                        risk_level = risk_assessment['risk_level']
                    else:
                        risk_level = 'UNKNOWN'
                    
                    fund_result = {
                        'fcode': fund_info['fcode'],
                        'fund_name': fund_info['fund_name'],
                        'capacity': fund_info['capacity'],
                        'investors': fund_info['investors'],
                        'risk_level': risk_level,
                        **perf
                    }
                    
                    # Sadece EXTREME olmayan fonlarƒ± dahil et
                    if risk_level != 'EXTREME':
                        performance_results.append(fund_result)
                    
                    # Risk istatistiklerini g√ºncelle
                    if risk_level == 'LOW':
                        risk_stats['low_risk'] += 1
                    elif risk_level == 'MEDIUM':
                        risk_stats['medium_risk'] += 1
                    elif risk_level == 'HIGH':
                        risk_stats['high_risk'] += 1
                    elif risk_level == 'EXTREME':
                        risk_stats['extreme_risk'] += 1
            
            if not performance_results:
                return {'success': False}
            
            # ƒ∞statistikleri hesapla
            total_funds = len(company_funds)
            safe_funds = risk_stats['low_risk'] + risk_stats['medium_risk']
            total_capacity = sum(r['capacity'] for r in performance_results)
            total_investors = sum(r['investors'] for r in performance_results)
            avg_return = sum(r['annual_return'] for r in performance_results) / len(performance_results)
            avg_sharpe = sum(r['sharpe_ratio'] for r in performance_results) / len(performance_results)
            avg_volatility = sum(r['volatility'] for r in performance_results) / len(performance_results)
            
            # Risk skoru hesapla (10 √ºzerinden)
            safe_fund_ratio = (safe_funds / total_funds) * 100
            risk_score = (safe_fund_ratio / 10) - (risk_stats['extreme_risk'] * 0.5)
            risk_score = max(0, min(10, risk_score))  # 0-10 arasƒ±
            
            # En iyi fonlarƒ± bul (EXTREME hari√ß)
            performance_results.sort(key=lambda x: x['sharpe_ratio'], reverse=True)
            
            return {
                'success': True,
                'stats': {
                    'total_funds': total_funds,
                    'total_capacity': total_capacity,
                    'total_investors': total_investors,
                    'avg_return': avg_return,
                    'avg_sharpe': avg_sharpe,
                    'avg_volatility': avg_volatility,
                    'safe_fund_ratio': safe_fund_ratio,
                    'risk_score': risk_score
                },
                'risk_stats': risk_stats,
                'top_funds': performance_results[:5],
                'all_funds': performance_results
            }
            
        except Exception as e:
            print(f"   ‚ùå {company_name} detaylƒ± analiz hatasƒ±: {e}")
            return {'success': False}

    def find_best_portfolio_company_unlimited(self):
        """En ba≈üarƒ±lƒ± portf√∂y ≈üirketini bul - T√úM ≈ûƒ∞RKETLER + Rƒ∞SK KONTROL√ú"""
        print(f"\nüèÜ EN BA≈ûARILI PORTF√ñY ≈ûƒ∞RKETƒ∞ ANALƒ∞Zƒ∞ - T√úM ≈ûƒ∞RKETLER (Rƒ∞SK KONTROL√ú ƒ∞LE)")
        print("="*75)
        
        company_results = []
        total_companies = len(self.company_keywords)
        
        for i, company_name in enumerate(self.company_keywords.keys(), 1):
            print(f"\nüìä [{i}/{total_companies}] {company_name} analizi...")
            
            try:
                result = self.analyze_company_detailed_data_with_risk(company_name, analysis_days=180)  # 6 ay
                
                if result['success']:
                    stats = result['stats']
                    risk_stats = result['risk_stats']
                    
                    # BA≈ûARI SKORU hesaplama (√ßok boyutlu) - Rƒ∞SK DAHƒ∞L
                    success_score = (
                        stats['avg_sharpe'] * 30 +          # Risk-ayarlƒ± getiri 
                        (stats['avg_return'] / 100) * 25 +   # Mutlak getiri 
                        (stats['safe_fund_ratio'] / 100) * 20 +  # G√ºvenlik oranƒ± (YENƒ∞)
                        (stats['total_funds'] / 10) * 10 +   # Fon √ße≈üitliliƒüi
                        min(stats['total_capacity'] / 1000000000, 5) * 10 +  # B√ºy√ºkl√ºk
                        (stats['risk_score'] / 10) * 15      # Risk skoru (YENƒ∞)
                    )
                    
                    # Extreme risk cezasƒ±
                    if risk_stats['extreme_risk'] > 0:
                        success_score -= risk_stats['extreme_risk'] * 2  # Her extreme fon i√ßin -2 puan
                    
                    company_results.append({
                        'company': company_name,
                        'success_score': success_score,
                        'risk_stats': risk_stats,
                        **stats,
                        'best_fund': result['top_funds'][0] if result['top_funds'] else None
                    })
                    
                    print(f"   ‚úÖ Ba≈üarƒ± Skoru: {success_score:.2f} (Risk dahil)")
                    print(f"   üõ°Ô∏è G√ºvenli: {risk_stats['low_risk']+risk_stats['medium_risk']}/{stats['total_funds']}")
                else:
                    print(f"   ‚ùå Veri yetersiz")
                    
            except Exception as e:
                print(f"   ‚ùå Hata: {e}")
                continue
        
        if not company_results:
            return "‚ùå Hi√ßbir ≈üirket analiz edilemedi."
        
        # Ba≈üarƒ± skoruna g√∂re sƒ±rala
        company_results.sort(key=lambda x: x['success_score'], reverse=True)
        
        return self.format_best_company_results_with_risk(company_results)

    def format_best_company_results_with_risk(self, results):
        """En ba≈üarƒ±lƒ± ≈üirket sonu√ßlarƒ±nƒ± formatla - Rƒ∞SK DAHƒ∞L"""
        
        response = f"\nüèÜ EN BA≈ûARILI PORTF√ñY Y√ñNETƒ∞M ≈ûƒ∞RKETƒ∞ SIRALAMASI (Rƒ∞SK KONTROL√ú ƒ∞LE)\n"
        response += f"{'='*70}\n\n"
        response += f"üìä {len(results)} ≈üirket analiz edildi (T√úM FONLARLA + Rƒ∞SK DEƒûERLENDƒ∞RME)\n\n"
        
        # TOP 10 ≈ûƒ∞RKET
        response += f"ü•á EN BA≈ûARILI 10 ≈ûƒ∞RKET (Risk-Ayarlƒ± Skorlama):\n\n"
        
        for i, company in enumerate(results[:10], 1):
            # Ba≈üarƒ± kategorisi
            score = company['success_score']
            if score > 20:
                rating = "üåü EFSANE"
            elif score > 15:
                rating = "‚≠ê M√úKEMMEL"
            elif score > 10:
                rating = "üî∂ √áOK ƒ∞Yƒ∞"
            elif score > 7:
                rating = "üî∏ ƒ∞Yƒ∞"
            elif score > 5:
                rating = "üü° ORTA"
            else:
                rating = "üîª ZAYIF"
            
            # Risk skoru
            risk_stats = company['risk_stats']
            total_funds = company['total_funds']
            safe_ratio = ((risk_stats['low_risk'] + risk_stats['medium_risk']) / total_funds) * 100
            
            response += f"{i:2d}. {company['company']} - {rating}\n"
            response += f"    üéØ Ba≈üarƒ± Skoru: {score:.2f}/30 (Risk dahil)\n"
            response += f"    üìä Fon Sayƒ±sƒ±: {company['total_funds']}\n"
            response += f"    üìà Ort. Getiri: %{company['avg_return']:+.2f}\n"
            response += f"    ‚ö° Ort. Sharpe: {company['avg_sharpe']:.3f}\n"
            response += f"    üõ°Ô∏è G√ºvenlik Oranƒ±: %{safe_ratio:.1f}\n"
            response += f"    üü¢ G√ºvenli: {risk_stats['low_risk'] + risk_stats['medium_risk']} fon\n"
            response += f"    üü† Riskli: {risk_stats['high_risk']} fon\n"
            response += f"    üî¥ Extreme: {risk_stats['extreme_risk']} fon\n"
            response += f"    üí∞ Varlƒ±k: {company['total_capacity']/1000000000:.1f} milyar TL\n"
            response += f"    üë• Yatƒ±rƒ±mcƒ±: {company['total_investors']:,} ki≈üi\n"
            
            if company['best_fund']:
                bf = company['best_fund']
                risk_indicator = self._get_risk_indicator(bf['risk_level'])
                response += f"    üèÜ En ƒ∞yi Fon: {bf['fcode']} (Sharpe: {bf['sharpe_ratio']:.3f}) {risk_indicator}\n"
            
            response += f"\n"
        
        # ≈ûAMPƒ∞YONLAR
        winner = results[0]
        response += f"üèÜ GENEL ≈ûAMPƒ∞YON: {winner['company']}\n"
        response += f"   üéØ Toplam Skor: {winner['success_score']:.2f} (Risk-ayarlƒ±)\n"
        response += f"   üìä {winner['total_funds']} fon ile %{winner['avg_return']:+.1f} ortalama getiri\n"
        response += f"   üõ°Ô∏è %{winner['safe_fund_ratio']:.1f} g√ºvenlik oranƒ±\n"
        
        # KATEGORƒ∞ ≈ûAMPƒ∞YONLARI
        response += f"\nüèÖ KATEGORƒ∞ ≈ûAMPƒ∞YONLARI:\n"
        
        # En y√ºksek getiri
        best_return = max(results, key=lambda x: x['avg_return'])
        response += f"   üìà En Y√ºksek Getiri: {best_return['company']} (%{best_return['avg_return']:+.1f})\n"
        
        # En iyi Sharpe
        best_sharpe = max(results, key=lambda x: x['avg_sharpe'])
        response += f"   ‚ö° En ƒ∞yi Sharpe: {best_sharpe['company']} ({best_sharpe['avg_sharpe']:.3f})\n"
        
        # En g√ºvenli
        safest = max(results, key=lambda x: x['safe_fund_ratio'])
        response += f"   üõ°Ô∏è En G√ºvenli: {safest['company']} (%{safest['safe_fund_ratio']:.1f} g√ºvenlik)\n"
        
        # En b√ºy√ºk varlƒ±k
        biggest_aum = max(results, key=lambda x: x['total_capacity'])
        response += f"   üí∞ En B√ºy√ºk Varlƒ±k: {biggest_aum['company']} ({biggest_aum['total_capacity']/1000000000:.1f} milyar TL)\n"
        
        # En √ßok fon
        most_funds = max(results, key=lambda x: x['total_funds'])
        response += f"   üìä En √áok Fon: {most_funds['company']} ({most_funds['total_funds']} fon)\n"
        
        # En pop√ºler
        most_popular = max(results, key=lambda x: x['total_investors'])
        response += f"   üë• En Pop√ºler: {most_popular['company']} ({most_popular['total_investors']:,} yatƒ±rƒ±mcƒ±)\n"
        
        # SEKT√ñR Rƒ∞SK ANALƒ∞Zƒ∞
        total_safe = sum(r['risk_stats']['low_risk'] + r['risk_stats']['medium_risk'] for r in results)
        total_risky = sum(r['risk_stats']['high_risk'] for r in results)
        total_extreme = sum(r['risk_stats']['extreme_risk'] for r in results)
        total_all_funds = sum(r['total_funds'] for r in results)
        
        response += f"\nüõ°Ô∏è SEKT√ñR Rƒ∞SK ANALƒ∞Zƒ∞:\n"
        response += f"   üü¢ G√ºvenli Fonlar: {total_safe} (%{total_safe/total_all_funds*100:.1f})\n"
        response += f"   üü† Y√ºksek Risk: {total_risky} (%{total_risky/total_all_funds*100:.1f})\n"
        response += f"   üî¥ Extreme Risk: {total_extreme} (%{total_extreme/total_all_funds*100:.1f})\n"
        
        if total_extreme > total_all_funds * 0.1:
            response += f"   ‚ö†Ô∏è Sekt√∂rde %{total_extreme/total_all_funds*100:.1f} extreme riskli fon var - dikkat!\n"
        
        # PERFORMANS DAƒûILIMI
        excellent = len([r for r in results if r['success_score'] > 15])
        good = len([r for r in results if 10 < r['success_score'] <= 15])
        average = len([r for r in results if 7 < r['success_score'] <= 10])
        poor = len([r for r in results if r['success_score'] <= 7])
        
        response += f"\nüìà PERFORMANS DAƒûILIMI (Risk-Ayarlƒ±):\n"
        response += f"   üåü M√ºkemmel (>15): {excellent} ≈üirket\n"
        response += f"   ‚≠ê √áok ƒ∞yi (10-15): {good} ≈üirket\n"
        response += f"   üî∂ ƒ∞yi (7-10): {average} ≈üirket\n"
        response += f"   üîª Geli≈ümeli (‚â§7): {poor} ≈üirket\n"
        
        # YATIRIM TAVSƒ∞YELERƒ∞
        response += f"\nüí° YATIRIM TAVSƒ∞YELERƒ∞:\n"
        response += f"   üéØ ƒ∞lk tercih: {results[0]['company']} (En y√ºksek risk-ayarlƒ± skor)\n"
        response += f"   üõ°Ô∏è G√ºvenlik i√ßin: {safest['company']} (En g√ºvenli portf√∂y)\n"
        response += f"   üìà Performans i√ßin: {best_sharpe['company']} (En iyi Sharpe)\n"
        response += f"   ‚ö†Ô∏è Extreme riskli fonlardan ka√ßƒ±nƒ±n ({total_extreme} fon tespit edildi)\n"
        response += f"   üîç Yatƒ±rƒ±m √∂ncesi mutlaka risk kontrol√º yapƒ±n\n"
        
        return response

    @staticmethod
    def get_examples():
        """Portf√∂y ≈üirketi analizi √∂rnekleri"""
        return [
            "ƒ∞≈ü Portf√∂y fonlarƒ± nasƒ±l performans g√∂steriyor?",
            "Ak Portf√∂y analizi",
            "Garanti Portf√∂y fonlarƒ±nƒ±n durumu nedir?",
            "En ba≈üarƒ±lƒ± portf√∂y ≈üirketi hangisi?",
            "ƒ∞≈ü Portf√∂y vs Ak Portf√∂y kar≈üƒ±la≈ütƒ±rmasƒ±",
            "QNB Portf√∂y fonlarƒ±",
            "Ata Portf√∂y performansƒ±"
        ]
    
    @staticmethod
    def get_keywords():
        """Portf√∂y ≈üirketleri i√ßin anahtar kelimeler"""
        return [
            "portf√∂y", "i≈ü portf√∂y", "ak portf√∂y", "garanti portf√∂y",
            "qnb portf√∂y", "ata portf√∂y", "fiba portf√∂y", "yapƒ± kredi portf√∂y",
            "ziraat portf√∂y", "vakƒ±f portf√∂y", "halk portf√∂y"
        ]
    
    @staticmethod
    def get_patterns():
        """Portf√∂y ≈üirketi pattern'leri"""
        return [
            {
                'type': 'regex',
                'pattern': r'(i≈ü|ak|garanti|qnb|ata|fiba)\s*portf√∂y',
                'score': 1.0
            },
            {
                'type': 'contains_all',
                'words': ['portf√∂y', '≈üirket'],
                'score': 0.85
            },
            {
                'type': 'contains_all',
                'words': ['ba≈üarƒ±lƒ±', 'portf√∂y'],
                'score': 0.9
            }
        ]
    
    @staticmethod
    def get_method_patterns():
        """Method mapping"""
        return {
            'analyze_company_comprehensive': ['analiz', 'performans', 'durum', 'nasƒ±l'],
            'compare_companies_unlimited': ['vs', 'kar≈üƒ±la≈ütƒ±r', 'kar≈üƒ±', 'compare'],
            'find_best_portfolio_company_unlimited': ['en ba≈üarƒ±lƒ±', 'en iyi', 'best']
        }