# predictive_scenario_analyzer.py
"""
Prediktif Senaryo Analizi - AI Destekli Gelecek Tahminleri
Mevcut scenario_analysis.py'yi kullanarak gelecek projeksiyonlarƒ± yapar
"""

import pandas as pd
import numpy as np
from datetime import datetime, timedelta
import re
from typing import Dict, List, Optional, Tuple

class PredictiveScenarioAnalyzer:
    """AI destekli gelecek senaryo tahminleri"""
    
    def __init__(self, coordinator, scenario_analyzer):
        self.coordinator = coordinator
        self.scenario_analyzer = scenario_analyzer
        self.db = coordinator.db
        self.ai_provider = coordinator.ai_provider if hasattr(coordinator, 'ai_provider') else None
        
        # Tahmin periyotlarƒ±
        self.time_periods = {
            'kƒ±sa_vade': {'days': 30, 'label': '1 ay'},
            'orta_vade': {'days': 90, 'label': '3 ay'},
            'uzun_vade': {'days': 180, 'label': '6 ay'}
        }
        
        # Senaryo tahmin parametreleri
        self.scenario_impacts = {
            'enflasyon': {
                'high': {'threshold': 80, 'multiplier': 1.5},
                'medium': {'threshold': 60, 'multiplier': 1.2},
                'low': {'threshold': 40, 'multiplier': 1.0}
            },
            'dolar': {
                'high': {'threshold': 40, 'multiplier': 1.4},
                'medium': {'threshold': 35, 'multiplier': 1.2},
                'low': {'threshold': 30, 'multiplier': 1.0}
            },
            'faiz': {
                'high': {'threshold': 60, 'multiplier': 1.3},
                'medium': {'threshold': 45, 'multiplier': 1.1},
                'low': {'threshold': 30, 'multiplier': 1.0}
            }
        }
    
    def is_predictive_question(self, question):
        """Tahmin sorusu mu kontrol√º"""
        question_lower = question.lower()
        
        predictive_keywords = [
            'tahmin', 'predict', 'gelecek', 'sonra', 'olacak',
            'beklenti', 'projeksiyon', '√∂ng√∂r√º', 'forecast',
            'ilerleyen', '√∂n√ºm√ºzdeki', 'vadede', 'sonunda',
            '2025', '2026', 'yƒ±l sonu', 'ay sonra', 'hafta sonra'
        ]
        
        return any(keyword in question_lower for keyword in predictive_keywords)
    
    def analyze_predictive_scenario(self, question):
        """Ana tahmin analizi metodu"""
        question_lower = question.lower()
        
        # Senaryo tipini belirle
        scenario_type = self._identify_scenario_type(question_lower)
        
        # Zaman periyodunu belirle
        time_period = self._extract_time_period(question_lower)
        
        # Hedef deƒüeri √ßƒ±kar
        target_value = self._extract_target_value(question_lower)
        
        print(f"üîÆ Prediktif Analiz: {scenario_type} - {time_period['label']} - Hedef: {target_value}")
        
        # Mevcut durumu analiz et
        current_state = self._analyze_current_state(scenario_type)
        
        # Tarihsel trendi analiz et
        historical_trend = self._analyze_historical_trend(scenario_type, time_period['days'])
        
        # AI tahminlerini al
        ai_predictions = self._get_ai_predictions(
            scenario_type, target_value, time_period, 
            current_state, historical_trend, question
        )
        
        # Sonu√ßlarƒ± formatla
        return self._format_predictive_results(
            scenario_type, target_value, time_period,
            current_state, historical_trend, ai_predictions
        )
    
    def _identify_scenario_type(self, question_lower):
        """Senaryo tipini belirle"""
        if any(word in question_lower for word in ['enflasyon', 't√ºfe', '√ºfe']):
            return 'enflasyon'
        elif any(word in question_lower for word in ['dolar', 'euro', 'd√∂viz', 'kur']):
            return 'd√∂viz'
        elif any(word in question_lower for word in ['faiz', 'tcmb', 'para politikasƒ±']):
            return 'faiz'
        elif any(word in question_lower for word in ['borsa', 'bist', 'hisse']):
            return 'borsa'
        else:
            return 'genel'
    
    def _extract_time_period(self, question_lower):
        """Zaman periyodunu √ßƒ±kar"""
        # Spesifik ay/g√ºn belirtimi
        month_match = re.search(r'(\d+)\s*ay', question_lower)
        if month_match:
            months = int(month_match.group(1))
            return {'days': months * 30, 'label': f'{months} ay'}
        
        # Yƒ±l sonu
        if 'yƒ±l sonu' in question_lower or '2025' in question_lower:
            today = datetime.now()
            year_end = datetime(today.year, 12, 31)
            days_to_end = (year_end - today).days
            return {'days': days_to_end, 'label': 'yƒ±l sonu'}
        
        # Kƒ±sa/orta/uzun vade
        if any(word in question_lower for word in ['kƒ±sa', 'yakƒ±n']):
            return self.time_periods['kƒ±sa_vade']
        elif any(word in question_lower for word in ['uzun', 'ileri']):
            return self.time_periods['uzun_vade']
        else:
            return self.time_periods['orta_vade']
    
    def _extract_target_value(self, question_lower):
        """Hedef deƒüeri √ßƒ±kar (√∂rn: enflasyon %80)"""
        # Y√ºzde deƒüeri
        percent_match = re.search(r'%?\s*(\d+)\s*%?', question_lower)
        if percent_match:
            return float(percent_match.group(1))
        
        # Dolar deƒüeri
        dollar_match = re.search(r'(\d+)\s*tl', question_lower)
        if dollar_match:
            return float(dollar_match.group(1))
        
        return None
    
    def _analyze_current_state(self, scenario_type):
        """Mevcut durumu analiz et"""
        try:
            # SQL d√ºzeltmesi - fund_type yerine protection_category kullan
            query = """
            SELECT 
                AVG(CASE WHEN protection_category = 'PARA_PIYASASI' THEN return_30d END) as money_market_avg,
                AVG(CASE WHEN gold_ratio > 30 THEN return_30d END) as gold_funds_avg,
                AVG(CASE WHEN fx_ratio > 30 THEN return_30d END) as fx_funds_avg,
                AVG(CASE WHEN equity_ratio > 50 THEN return_30d END) as equity_funds_avg,
                AVG(volatility_30d) as avg_volatility,
                COUNT(DISTINCT fcode) as total_funds
            FROM mv_scenario_analysis_funds
            WHERE return_30d IS NOT NULL
            """
            
            result = self.db.execute_query(query)
            
            if not result.empty:
                row = result.iloc[0].to_dict()
                # NULL deƒüerleri kontrol et
                for key in row:
                    if pd.isna(row[key]):
                        if 'avg' in key:
                            row[key] = 0.8 if 'money_market' in key else 2.0
                        elif key == 'total_funds':
                            row[key] = 100
                return row
                
        except Exception as e:
            print(f"Mevcut durum analizi hatasƒ±: {e}")
        
        # Varsayƒ±lan deƒüerler
        return {
            'money_market_avg': 0.8,
            'gold_funds_avg': 2.5,
            'fx_funds_avg': 1.8,
            'equity_funds_avg': 1.2,
            'avg_volatility': 15.0,
            'total_funds': 1700
        }    
    def _analyze_historical_trend(self, scenario_type, days):
        """Tarihsel trend analizi"""
        try:
            # Senaryo tipine g√∂re ilgili fonlarƒ± se√ß
            if scenario_type == 'enflasyon':
                fund_filter = "gold_ratio > 30 OR equity_ratio > 50"
            elif scenario_type == 'd√∂viz':
                fund_filter = "fx_ratio > 30"
            elif scenario_type == 'faiz':
                fund_filter = "bond_ratio > 30 OR money_market_ratio > 50"
            else:
                fund_filter = "1=1"
            
            # Daha basit ve g√ºvenilir sorgu
            query = f"""
            SELECT 
                s.fcode,
                s.return_30d,
                s.return_90d,
                s.volatility_30d
            FROM mv_scenario_analysis_funds s
            WHERE {fund_filter}
            AND s.return_30d IS NOT NULL
            AND s.volatility_30d IS NOT NULL
            AND s.volatility_30d < 100  -- A≈üƒ±rƒ± deƒüerleri filtrele
            LIMIT 100
            """
            
            result = self.db.execute_query(query)
            
            if not result.empty:
                avg_return = result['return_30d'].mean()
                avg_volatility = result['volatility_30d'].mean()
                fund_count = len(result)
                
                # Mantƒ±klƒ± deƒüer aralƒ±ƒüƒ±nda tut
                avg_volatility = min(avg_volatility, 50.0)  # Max %50 volatilite
                
                return {
                    'avg_return': avg_return,
                    'return_volatility': avg_volatility,
                    'fund_count': fund_count
                }
                    
        except Exception as e:
            print(f"Tarihsel trend hatasƒ±: {e}")
        
        return {
            'avg_return': 10.0,
            'return_volatility': 20.0,
            'fund_count': 50
        }

    def _get_ai_predictions(self, scenario_type, target_value, time_period, 
                        current_state, historical_trend, original_question):
        """AI tahminlerini al"""
        
        if not self.ai_provider or not self.ai_provider.is_available():
            return self._generate_rule_based_predictions(
                scenario_type, target_value, time_period, current_state, historical_trend
            )
        
        # Ger√ßek fonlarƒ± al
        affected_funds = self._get_scenario_relevant_funds_simple(scenario_type)
        
        # En iyi fonlarƒ± se√ß
        top_funds = {
            'gold': [],
            'fx': [],
            'equity': [],
            'money_market': []
        }
        
        for fund in affected_funds[:20]:  # ƒ∞lk 20 fon
            if fund.get('gold_ratio', 0) > 30:
                top_funds['gold'].append(fund['fcode'])
            elif fund.get('fx_ratio', 0) > 30:
                top_funds['fx'].append(fund['fcode'])
            elif fund.get('equity_ratio', 0) > 50:
                top_funds['equity'].append(fund['fcode'])
            elif fund.get('money_market_ratio', 0) > 50:
                top_funds['money_market'].append(fund['fcode'])
        
        # AI prompt hazƒ±rla
        prompt = f"""
        SENARYO TAHMƒ∞Nƒ∞: {scenario_type.upper()}
        Zaman: {time_period['label']} ({time_period['days']} g√ºn)
        Hedef Deƒüer: {target_value if target_value else 'Belirtilmemi≈ü'}
        
        MEVCUT DURUM:
        - Para Piyasasƒ± Fonlarƒ± Ortalama Getiri: %{current_state['money_market_avg']:.2f}
        - Altƒ±n Fonlarƒ± Ortalama Getiri: %{current_state['gold_funds_avg']:.2f}
        - D√∂viz Fonlarƒ± Ortalama Getiri: %{current_state['fx_funds_avg']:.2f}
        - Hisse Fonlarƒ± Ortalama Getiri: %{current_state['equity_funds_avg']:.2f}
        - Ortalama Volatilite: %{current_state['avg_volatility']:.2f}
        
        GER√áEK FON KODLARI (3 harfli TEFAS kodlarƒ±):
        - Altƒ±n Fonlarƒ±: {', '.join(top_funds['gold'][:5]) or 'AFO, GEA, AFA, TKF, GAF'}
        - D√∂viz Fonlarƒ±: {', '.join(top_funds['fx'][:5]) or 'AKE, IDA, IDE, YAC, TTE'}
        - Hisse Fonlarƒ±: {', '.join(top_funds['equity'][:5]) or 'TI2, YAS, AKU, TYH, GMR'}
        - Para Piyasasƒ±: {', '.join(top_funds['money_market'][:5]) or 'IPB, GEL, AK3, TI3, TPL'}
        
        √ñNEMLƒ∞: Sadece yukarƒ±da verilen GER√áEK FON KODLARINI kullan! 
        Kesinlikle PP1234, AF2345 gibi uydurma kodlar KULLANMA!
        
        G√ñREVLER:
        
        1. TAHMƒ∞Nƒ∞ ETKƒ∞ ANALƒ∞Zƒ∞:
        - Her fon kategorisi i√ßin beklenen getiri deƒüi≈üimi
        - Yukarƒ±daki GER√áEK FON KODLARINDAN en √ßok etkilenecek 5 tanesini se√ß
        - Her biri i√ßin tahmini etki %'si (-100% ile +100% arasƒ±)
        
        2. KORUNMA STRATEJƒ∞Sƒ∞:
        - Yukarƒ±daki GER√áEK FON KODLARINDAN en iyi koruma saƒülayacak 5 tanesini se√ß
        - Her birinin korunma mekanizmasƒ±
        
        3. ZAMAN √áƒ∞ZELGESƒ∞:
        - ƒ∞lk etkilerin g√∂r√ºleceƒüi zaman (g√ºn/hafta)
        - Maksimum etkinin olu≈üacaƒüƒ± zaman
        - Toparlanma s√ºresi tahmini
        
        4. OLASILIK ANALƒ∞Zƒ∞:
        - Senaryonun ger√ßekle≈üme olasƒ±lƒ±ƒüƒ± (0-100)
        - Ana risk fakt√∂rleri
        - ƒ∞zlenmesi gereken g√∂stergeler
        
        5. AKSƒ∞YON PLANI:
        - Hemen yapƒ±lmasƒ± gerekenler
        - {time_period['label']} i√ßinde yapƒ±lacaklar
        - √áƒ±kƒ±≈ü stratejisi
        
        Yanƒ±tƒ±nda SADECE verilen ger√ßek fon kodlarƒ±nƒ± kullan!
        """
        
        system_prompt = """Sen deneyimli bir TEFAS fon analistisin.
        SADECE sana verilen ger√ßek fon kodlarƒ±nƒ± kullanmalƒ±sƒ±n.
        Asla uydurma fon kodu √ºretme! Her fon kodu 3 harfli olmalƒ±."""
        
        try:
            ai_response = self.ai_provider.query(prompt, system_prompt)
            return self._parse_ai_predictions(ai_response)
        except Exception as e:
            print(f"AI tahmin hatasƒ±: {e}")
            return self._generate_rule_based_predictions(
                scenario_type, target_value, time_period, current_state, historical_trend
            )

    def _parse_ai_predictions(self, ai_response):
        """AI yanƒ±tƒ±nƒ± parse et"""
        # AI yanƒ±tƒ± zaten formatlanmƒ±≈ü gelecek
        return {
            'raw_prediction': ai_response,
            'parsed': True
        }
    
    def _get_scenario_relevant_funds_simple(self, scenario_type):
        """Senaryoya uygun GER√áEK fonlarƒ± veritabanƒ±ndan √ßek"""
        try:
            print(f"[DEBUG] {scenario_type} i√ßin ger√ßek fonlar y√ºkleniyor...")
            
            # √ñnce hangi tablolar/kolonlar mevcut kontrol edelim
            check_tables_query = """
            SELECT table_name, column_name 
            FROM information_schema.columns 
            WHERE table_schema = 'public' 
            AND table_name IN ('tefasfunds', 'tefasfunddetails', 'mv_latest_fund_data', 'mv_scenario_analysis_funds')
            AND column_name IN ('fund_type', 'fund_category', 'ftitle', 'fund_name', 'protection_category', 
                            'gold_ratio', 'fx_ratio', 'equity_ratio', 'money_market_ratio')
            ORDER BY table_name, column_name
            """
            
            schema_info = self.db.execute_query(check_tables_query)
            print("[DEBUG] Mevcut kolonlar:")
            for _, row in schema_info.iterrows():
                print(f"  - {row['table_name']}.{row['column_name']}")
            
            # Eƒüer mv_scenario_analysis_funds varsa √∂nce onu dene
            if 'mv_scenario_analysis_funds' in schema_info['table_name'].values:
                return self._get_funds_from_mv(scenario_type)
            
            # Yoksa basit bir sorgu ile devam et
            return self._get_funds_basic(scenario_type)
            
        except Exception as e:
            print(f"‚ùå Veritabanƒ± hatasƒ±: {e}")
            return []

    def _get_funds_from_mv(self, scenario_type):
        """MV'den kategori bilgisiyle fonlarƒ± √ßek"""
        try:
            if scenario_type == 'enflasyon':
                query = """
                SELECT 
                    fcode,
                    fund_name,
                    current_price,
                    gold_ratio,
                    fx_ratio,
                    equity_ratio,
                    money_market_ratio,
                    protection_category,
                    inflation_protection_score
                FROM mv_scenario_analysis_funds
                WHERE (gold_ratio > 20 OR fx_ratio > 20 OR equity_ratio > 40)
                AND current_price IS NOT NULL
                ORDER BY 
                    CASE 
                        WHEN gold_ratio > 50 THEN 1
                        WHEN fx_ratio > 50 THEN 2
                        WHEN equity_ratio > 50 THEN 3
                        ELSE 4
                    END,
                    inflation_protection_score DESC NULLS LAST
                LIMIT 30
                """
            
            elif scenario_type == 'd√∂viz':
                query = """
                SELECT 
                    fcode,
                    fund_name,
                    current_price,
                    fx_ratio,
                    protection_category
                FROM mv_scenario_analysis_funds
                WHERE fx_ratio > 30
                AND current_price IS NOT NULL
                ORDER BY fx_ratio DESC
                LIMIT 20
                """
            
            else:  # Genel
                query = """
                SELECT 
                    fcode,
                    fund_name,
                    current_price,
                    protection_category
                FROM mv_scenario_analysis_funds
                WHERE current_price IS NOT NULL
                ORDER BY investorcount DESC NULLS LAST
                LIMIT 20
                """
            
            result = self.db.execute_query(query)
            
            if result.empty:
                print(f"‚ùå MV'de {scenario_type} i√ßin uygun fon bulunamadƒ±")
                return self._get_funds_basic(scenario_type)
            
            funds = []
            for _, row in result.iterrows():
                fund_data = {
                    'fcode': row['fcode'],
                    'fund_name': row.get('fund_name', ''),
                    'current_price': float(row['current_price']),
                    'category': row.get('protection_category', 'BILINMIYOR')
                }
                
                # Kategoriye g√∂re ek bilgi
                if scenario_type == 'enflasyon':
                    if row.get('gold_ratio', 0) > 50:
                        fund_data['type'] = 'ALTIN'
                        fund_data['ratio'] = row['gold_ratio']
                    elif row.get('fx_ratio', 0) > 50:
                        fund_data['type'] = 'DOVIZ'
                        fund_data['ratio'] = row['fx_ratio']
                    elif row.get('equity_ratio', 0) > 50:
                        fund_data['type'] = 'HISSE'
                        fund_data['ratio'] = row['equity_ratio']
                    else:
                        fund_data['type'] = 'KARMA'
                        fund_data['ratio'] = 0
                
                funds.append(fund_data)
            
            print(f"‚úÖ MV'den {len(funds)} fon y√ºklendi")
            print(f"[DEBUG] ƒ∞lk 5 fon: {[(f['fcode'], f.get('type', 'N/A')) for f in funds[:5]]}")
            
            return funds
            
        except Exception as e:
            print(f"‚ùå MV sorgu hatasƒ±: {e}")
            return self._get_funds_basic(scenario_type)

    def _get_funds_basic(self, scenario_type):
        """Basit sorgu - sadece aktif fonlarƒ± getir"""
        try:
            # En basit hali - sadece son i≈ülem g√∂ren fonlar
            query = """
            WITH latest_funds AS (
                SELECT DISTINCT ON (fcode) 
                    fcode, 
                    price,
                    investorcount,
                    pdate
                FROM tefasfunds
                WHERE pdate >= CURRENT_DATE - INTERVAL '7 days'
                AND investorcount > 50  -- En az 50 yatƒ±rƒ±mcƒ±
                ORDER BY fcode, pdate DESC
            )
            SELECT 
                fcode,
                price as current_price,
                investorcount
            FROM latest_funds
            ORDER BY 
                CASE 
                    WHEN investorcount > 10000 THEN 1  -- Pop√ºler fonlar
                    WHEN investorcount > 1000 THEN 2   -- Orta
                    ELSE 3                              -- Az bilinen
                END,
                fcode
            LIMIT 30
            """
            
            result = self.db.execute_query(query)
            
            if result.empty:
                print("‚ùå Hi√ß aktif fon bulunamadƒ±!")
                return []
            
            funds = []
            for _, row in result.iterrows():
                funds.append({
                    'fcode': row['fcode'],
                    'current_price': float(row['current_price']),
                    'investors': int(row['investorcount']),
                    'category': 'BILINMIYOR'  # Kategori bilgisi yok
                })
            
            print(f"‚úÖ Basit sorgudan {len(funds)} fon bulundu")
            print(f"[DEBUG] En pop√ºler 5 fon: {[(f['fcode'], f['investors']) for f in funds[:5]]}")
            
            return funds
            
        except Exception as e:
            print(f"‚ùå Basit sorgu hatasƒ±: {e}")
            return []

    def _generate_rule_based_predictions(self, scenario_type, target_value, 
                                    time_period, current_state, historical_trend):
        """Kural tabanlƒ± tahminler - GER√áEK FONLARLA"""
        
        # Ger√ßek fonlarƒ± al
        real_funds = self._get_scenario_relevant_funds_simple(scenario_type)
        
        if not real_funds:
            return {
                'raw_prediction': f"""
    ‚ùå YETERSIZ VERƒ∞

    {scenario_type.upper()} senaryosu i√ßin veritabanƒ±nda yeterli fon verisi bulunamadƒ±.

    Olasƒ± sebepler:
    - Veritabanƒ± baƒülantƒ± problemi
    - G√ºncel fon verisi yok
    - Sorgu hatasƒ±

    L√ºtfen daha sonra tekrar deneyin.
    """,
                'parsed': False
            }
        
        predictions = {
            'impact_analysis': {},
            'protection_funds': [],
            'timeline': {},
            'probability': 0,
            'action_plan': []
        }
        
        # Senaryo tipine g√∂re tahminler
        if scenario_type == 'enflasyon':
            impact_multiplier = 1.5 if target_value and target_value > 80 else 1.2
            
            predictions['impact_analysis'] = {
                'para_piyasasƒ±': -10 * impact_multiplier,
                'tahvil': -8 * impact_multiplier,
                'altƒ±n': 25 * impact_multiplier,
                'hisse': 15 * impact_multiplier,
                'd√∂viz': 20 * impact_multiplier
            }
            
            # Fonlarƒ± kategorize et (eƒüer MV'den geldiyse type bilgisi var)
            gold_funds = [f for f in real_funds if f.get('type') == 'ALTIN']
            fx_funds = [f for f in real_funds if f.get('type') == 'DOVIZ']
            equity_funds = [f for f in real_funds if f.get('type') == 'HISSE']
            
            # Eƒüer kategorize edilmemi≈üse, en pop√ºlerleri al
            if not gold_funds and not fx_funds and not equity_funds:
                # Pop√ºlerlik sƒ±rasƒ±na g√∂re daƒüƒ±t
                total = len(real_funds)
                gold_funds = real_funds[:total//3]
                fx_funds = real_funds[total//3:2*total//3]
                equity_funds = real_funds[2*total//3:]
            
            # Koruma fonlarƒ± √∂ner
            for fund in gold_funds[:2]:
                predictions['protection_funds'].append(
                    (fund['fcode'], f"Y√ºksek yatƒ±rƒ±mcƒ±lƒ± fon ({fund.get('investors', 'N/A')} ki≈üi)")
                )
            
            for fund in fx_funds[:2]:
                predictions['protection_funds'].append(
                    (fund['fcode'], f"Pop√ºler fon - {fund.get('investors', 'N/A')} yatƒ±rƒ±mcƒ±")
                )
            
            if equity_funds:
                predictions['protection_funds'].append(
                    (equity_funds[0]['fcode'], f"Aktif i≈ülem g√∂ren fon")
                )
            
            predictions['probability'] = 70 if target_value and target_value > 70 else 50
        
        # Diƒüer senaryolar benzer ≈üekilde...
        
        # Zaman √ßizelgesi
        predictions['timeline'] = {
            'ilk_etki': f"{max(time_period['days'] // 10, 7)} g√ºn",
            'maksimum_etki': f"{time_period['days'] // 2} g√ºn",
            'toparlanma': f"{time_period['days'] * 2} g√ºn"
        }
        
        # Aksiyon planƒ±
        predictions['action_plan'] = [
            'Portf√∂y√º g√∂zden ge√ßir',
            f"Listelenen {len(predictions['protection_funds'])} fondan uygun olanlarƒ± ara≈ütƒ±r",
            'Fon detaylarƒ±nƒ± incele (prospekt√ºs, ge√ßmi≈ü performans)',
            'Risk y√∂netimine dikkat et'
        ]
        
        return {
            'raw_prediction': self._format_rule_based_predictions(predictions, scenario_type, time_period),
            'parsed': False
        }
    def _format_rule_based_predictions(self, predictions, scenario_type, time_period):
        """Kural tabanlƒ± tahminleri formatla"""
        
        response = f"üìä KURAL TABANLI TAHMƒ∞N ({scenario_type.upper()})\n\n"
        
        response += f"1Ô∏è‚É£ TAHMƒ∞Nƒ∞ ETKƒ∞ ANALƒ∞Zƒ∞ ({time_period['label']}):\n"
        for category, impact in predictions['impact_analysis'].items():
            icon = "üìà" if impact > 0 else "üìâ"
            response += f"   {icon} {category.title()}: %{impact:+.1f}\n"
        
        response += f"\n2Ô∏è‚É£ KORUNMA SAƒûLAYACAK FONLAR:\n"
        for i, (fund, reason) in enumerate(predictions['protection_funds'][:5], 1):
            response += f"   {i}. {fund}: {reason}\n"
        
        # Eƒüer ger√ßek fon bulunamadƒ±ysa uyarƒ± ekle
        if len(predictions['protection_funds']) < 3:
            response += f"\n   ‚ö†Ô∏è Not: Yeterli sayƒ±da uygun fon bulunamadƒ±.\n"
            response += f"   üí° √ñneri: Altƒ±n (AFO, GEA), D√∂viz (AKE, IDA) fonlarƒ±nƒ± ara≈ütƒ±rƒ±n.\n"
        
        response += f"\n3Ô∏è‚É£ ZAMAN √áƒ∞ZELGESƒ∞:\n"
        response += f"   üïê ƒ∞lk etki: {predictions['timeline']['ilk_etki']}\n"
        response += f"   üéØ Maksimum etki: {predictions['timeline']['maksimum_etki']}\n"
        response += f"   üîÑ Toparlanma: {predictions['timeline']['toparlanma']}\n"
        
        response += f"\n4Ô∏è‚É£ OLASILIK ANALƒ∞Zƒ∞:\n"
        response += f"   üìä Ger√ßekle≈üme olasƒ±lƒ±ƒüƒ±: %{predictions['probability']}\n"
        response += f"   ‚ö†Ô∏è Risk fakt√∂rleri: K√ºresel geli≈ümeler, TCMB kararlarƒ±\n"
        response += f"   üëÅÔ∏è ƒ∞zlenecek: T√úFE, Dolar/TL, Altƒ±n fiyatlarƒ±\n"
        
        response += f"\n5Ô∏è‚É£ AKSƒ∞YON PLANI:\n"
        for i, action in enumerate(predictions['action_plan'], 1):
            response += f"   {i}. {action}\n"
        
        return response    
    def _format_predictive_results(self, scenario_type, target_value, time_period,
                                  current_state, historical_trend, ai_predictions):
        """Tahmin sonu√ßlarƒ±nƒ± formatla"""
        
        response = f"\nüîÆ PREDƒ∞KTƒ∞F SENARYO ANALƒ∞Zƒ∞\n"
        response += f"{'='*60}\n\n"
        
        response += f"üìä SENARYO: {scenario_type.upper()}"
        if target_value:
            response += f" - HEDEF: {target_value}"
        response += f"\nüìÖ TAHMƒ∞N PERƒ∞YODU: {time_period['label']} ({time_period['days']} g√ºn)\n"
        response += f"üïê Analiz Zamanƒ±: {datetime.now().strftime('%Y-%m-%d %H:%M')}\n\n"
        
        # Mevcut durum √∂zeti
        response += f"üìà MEVCUT DURUM:\n"
        response += f"   ‚Ä¢ Ortalama Volatilite: %{current_state['avg_volatility']:.2f}\n"
        response += f"   ‚Ä¢ Para Piyasasƒ± Getirisi: %{current_state['money_market_avg']:.2f}\n"
        response += f"   ‚Ä¢ Altƒ±n Fonlarƒ± Getirisi: %{current_state['gold_funds_avg']:.2f}\n"
        response += f"   ‚Ä¢ D√∂viz Fonlarƒ± Getirisi: %{current_state['fx_funds_avg']:.2f}\n\n"
        
        # Tarihsel trend
        response += f"üìä TARƒ∞HSEL TREND ({time_period['days']} g√ºnl√ºk):\n"
        response += f"   ‚Ä¢ Ortalama Getiri: %{historical_trend['avg_return']:.2f}\n"
        response += f"   ‚Ä¢ Volatilite: %{historical_trend['return_volatility']:.2f}\n"
        response += f"   ‚Ä¢ Veri Sayƒ±sƒ±: {historical_trend['fund_count']} fon\n\n"
        
        # AI tahminleri
        response += f"ü§ñ AI TAHMƒ∞NLERƒ∞:\n"
        response += f"{'='*60}\n"
        response += ai_predictions['raw_prediction']
        response += f"\n{'='*60}\n"
        
        # Risk uyarƒ±larƒ±
        response += f"\n‚ö†Ô∏è √ñNEMLƒ∞ UYARILAR:\n"
        response += f"   ‚Ä¢ Bu tahminler tarihsel verilere ve AI analizine dayanƒ±r\n"
        response += f"   ‚Ä¢ Piyasa ko≈üullarƒ± ani deƒüi≈üebilir\n"
        response += f"   ‚Ä¢ Kesin sonu√ß garantisi verilmez\n"
        response += f"   ‚Ä¢ Yatƒ±rƒ±m kararlarƒ±nda profesyonel destek alƒ±n\n"
        response += f"   ‚Ä¢ Portf√∂y√ºn√ºz√º √ße≈üitlendirin\n"
        
        return response
    
    @staticmethod
    def get_examples():
        """Prediktif analiz √∂rnekleri"""
        return [
            "Enflasyon %80 olursa 6 ay sonra fonlar nasƒ±l etkilenir?",
            "Dolar 40 TL olursa gelecek 3 ay tahmini?",
            "Faiz %60'a √ßƒ±karsa yƒ±l sonu fon performanslarƒ±?",
            "2025 sonunda hangi fonlar en iyi performans g√∂sterir?",
            "√ñn√ºm√ºzdeki 3 ayda altƒ±n fonlarƒ± tahmini?",
            "Kƒ±sa vadede d√∂viz fonlarƒ± nasƒ±l performans g√∂sterir?"
        ]
    
    @staticmethod
    def get_keywords():
        """Prediktif analiz anahtar kelimeleri"""
        return [
            "tahmin", "predict", "gelecek", "sonra", "olacak",
            "beklenti", "projeksiyon", "√∂ng√∂r√º", "forecast",
            "vadede", "2025", "2026", "yƒ±l sonu"
        ]
    
    @staticmethod
    def get_patterns():
        """Prediktif analiz pattern'leri"""
        return [
            {
                'type': 'regex',
                'pattern': r'(\d+\s*ay|yƒ±l)\s*(sonra|sonunda)',
                'score': 0.95
            },
            {
                'type': 'contains_all',
                'words': ['tahmin', 'fon'],
                'score': 0.90
            },
            {
                'type': 'regex',
                'pattern': r'gelecek\s*\d+\s*(ay|g√ºn|hafta)',
                'score': 0.95
            }
        ]